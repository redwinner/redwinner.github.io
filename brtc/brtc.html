<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8">
<title>Baidu-RTC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
<script type="text/javascript" src="https://code.bdstatic.com/npm/jquery@2.1.0/dist/jquery.min.js" ></script>
<script type="text/javascript" src="https://code.bdstatic.com/npm/jquery-blockui@2.7.0/jquery.blockUI.js" ></script>
<script type="text/javascript" src="https://brtc-sdk.cdn.bcebos.com/npm/baidurtc@1.2.7/baidu.rtc.sdk.js" ></script>
<script type="text/javascript" src="https://code.bdstatic.com/npm/baidurtc@1.0.1/demo/js.cookie.js"></script>
<link rel="stylesheet" href="https://code.bdstatic.com/npm/bootswatch@3.3.7/cerulean/bootstrap.min.css" type="text/css">
<link rel="stylesheet" href="https://code.bdstatic.com/npm/baidurtc@1.0.1/demo/css/demo.css" type="text/css">
<style type="text/css">
.hide {
    display: none !important;
}

.rtc-input-line {
    border-bottom: 2px solid #4D66FE;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    font-size: 16px;
    color: #4D66FE;
}

.rtc-font-color {
    font-size: 12px;
    color: #4D66FE;
}

.rtc-title-font-color {
    font-size: 20px;
    color: #1A1C47;
}
.gotoBaidu{height:20px;top:0;}
.gotobd{position:absolute;width:1170px;top:0;right:auto;bottom:0;left:50%;margin-left:-595px;text-align:right;line-height:20px;font-size:14px;padding-right:20px;}
.gotobd a{color:#000; float: right; margin-left: 15px;}
.gotobd a.subxm{color:#505050;}
table,table tr th, table tr td { border:1px solid #0094ff; }
table { width: 800px; min-height: 25px; line-height: 25px; text-align: left; border-collapse: collapse;}
</style>
</head>
<body>

<script >

function GetRequest() {
    var url = location.search;
    var theRequest = {};
    if (url.indexOf('?') !== -1) {
        var str = url.substr(1);
        var strs = str.split('&');
        for (var i = 0; i < strs.length; i++) {
            theRequest[strs[i].split('=')[0]] = decodeURIComponent(strs[i].split('=')[1]);
        }
    }
    return theRequest;
}

var gRequest = GetRequest();
var defaultDeviceID = null;
var gDoPing = false;
var gDoPong = false;
var gPingStartupTime = 8000;
var gPingRepeatTime  = 5000;
var gAsPublisher = true;
var gShareScreen = false;
var gRtmpmix = false;
var gRtmpMixLayoutIndex = '';
var gRecording = false;
var gAutoSubScribe = true;
var gAutoPlayMuted = false;
var gAutoPublish = true;
var gUsingData = true;
var gUsingVideo = true;
var gUsingAudio = true;
var gReceivingVideo = true;
var gReceivingAudio = true;
var gShowVideobps = true;
var gVideoProfile = 'hires';
var gScreenProfile = 'raw';
var gWaitPermissionTimeOutMs = 30000;
var gCandidateIP = null;
var gCandidatePort = null;
var gMediaServerIP = null;
var gShowSpinner = true;
var gUserEvent = true;
var gSessionEvent = true;
var gAutologin = false;
// 'playing'
var gState  = 'init';
var gBitRate = 1500;
var gAudioBitRate = null;
var gAudioStereo = false;
var gPreviewLocal = false;
var gUsingMessageAPI = false;
var gVolumeMonitor = false;
var gMirrorLocalVideo = true;
var gReportMonitorData = false;
var gReportEnv = 'online';
var gDynamicRemoteVideoView = false;
var gLog = false;
var gName = 'brtc webclient';
var gMultiStreamSDK = false;
var gVideoCodec = 'h264'; // 'vp8', 'vp9', 'h263', 'h265', 'h266', 'av1'
var gAudioCodec = ''; // 'opus', 'pcmu', 'pcma', 'g722', 'isac16', 'isac32'

var gMuted = false;
var gVideoMuted = false;
var gPublished = true;

$(document).ready(function () {
    $('#roomname').attr('value', Cookies.get('roomname_at_aapid_page'));
    $('#appid').attr('value', Cookies.get('appid'));
    $('#userid').attr('value', Cookies.get('userid'));
    $('#token').attr('value', Cookies.get('token'));

    gState = Cookies.get('state');

    if (typeof gState === 'undefined') {
        gState = 'init';
    }

    var input_userid = '100' + Math.floor(Math.random() * 1000000).toString();
    var rtmp_server = '';

    if (gRequest['a']) {
        gRequest['appid'] = gRequest['a'];
    }
    if (gRequest['ac']) {
        gRequest['audiocodec'] = gRequest['ac'];
    }
    if (gRequest['b']) {
        gRequest['bitrate'] = gRequest['b'];
    }
    if (gRequest['c']) {
        gRequest['candidateip'] = gRequest['c'];
    }
    if (gRequest['cp']) {
        gRequest['candidateport'] = gRequest['cp'];
    }
    if (gRequest['d']) {
        gRequest['displayname'] = gRequest['d'];
    }
    if (gRequest['r']) {
        gRequest['roomname'] = gRequest['r'];
    }
    if (gRequest['u']) {
        gRequest['userid'] = gRequest['u'];
    }
    if (gRequest['vc']) {
        gRequest['videocodec'] = gRequest['vc'];
    }
    if (gRequest['vp']) {
        gRequest['videoprofile'] = gRequest['vp'];
    }
    if (gRequest['l']) {
        gRequest['listener_only'] = gRequest['l'];
    }
    if (gRequest['mi']) {
        gRequest['mediaserverip'] = gRequest['mi'];
    }
    if (gRequest['mn']) {
        gRequest['mediaserverdn'] = gRequest['mn'];
    }
    if (gRequest['na']) {
        gRequest['no_audio'] = gRequest['na'];
    }
    if (gRequest['nv']) {
        gRequest['no_video'] = gRequest['nv'];
    }
    if (gRequest['ns']) {
        gRequest['no_autosubscribe'] = gRequest['ns'];
    }
    if (gRequest['np']) {
        gRequest['no_autopublish'] = gRequest['np'];
    }
    if (gRequest['s']) {
        gRequest['brtcserver'] = gRequest['s'];
    }
    if (gRequest['ss']) {
        gRequest['sharescreen'] = gRequest['ss'];
    }
    if (gRequest['t']) {
        gRequest['token'] = gRequest['t'];
    }

    if (gRequest['roomname']) {
        $('#roomname').attr('value', gRequest['roomname']);
    }
    if (gRequest['appid']) {
        $('#appid').attr('value', gRequest['appid']);
    }
    if (gRequest['userid']) {
        input_userid = gRequest['userid'];
    }
    if (gRequest['token']) {
        $('#token').attr('value', gRequest['token']);
    }
    if (gRequest['ping']) {
        gDoPing = true;
    }
    if (gRequest['pong']) {
        gDoPong = true;
    }
    if (gRequest['ping_startup_time_ms']) {
        gPingStartupTime = gRequest['ping_startup_time_ms'];
    }
    if (gRequest['ping_repeat_time_ms']) {
        gPingRepeatTime = gRequest['ping_repeat_time_ms'];
    }
    if (gRequest['listener_only']) {
        gAsPublisher = false;
        gAutoPublish = false;
    }
    if (gRequest['sharescreen']) {
        gShareScreen = true;
    }
    if (gRequest['brtcserver']) {
        $('#brtcserver').removeClass('hide').show();
        // wss://
        if (gRequest['brtcserver'].length > 5) {
            $('#brtcserver').attr('value', gRequest['brtcserver']);
        }
    }
    if (gRequest['rtmpserver']) {
        $('#rtmpserver').removeClass('hide').show();
        // rtmp://
        if (gRequest['rtmpserver'].length > 5) {
            $('#rtmpserver').attr('value', gRequest['rtmpserver']);
        }
    }
    if (gRequest['rtmpmix']) {
        gRtmpmix = true;
    }
    if (gRequest['rtmpmixtemplate']) {
        // side_by_side_primary_720p_16_9, side_by_side_equal_720p_16_9, picture_in_picture_bottom_720p_16_9
        $('#rtmpmixtemplate').removeClass('hide').show();
        $('#rtmpmixtemplate').attr('value', gRequest['rtmpmixtemplate']);
    }

    if (gRequest['rtmpmixlayoutindex']) {
        gRtmpMixLayoutIndex = gRequest['rtmpmixlayoutindex'];
    }

    if (gRequest['recording']) {
        gRecording = true;
    }
    if (gRequest['no_autosubscribe']) {
        gAutoSubScribe = false;
        $('#pullvideo').removeClass('hide').show();
        $('#manualvideo').removeClass('hide').show();
        $('#therevideo').hide();
        let sel = document.getElementById('feedid');
        sel.options.add(new Option('NOT video(place holder)', 999999999));
        $('#feedid').change(function () {
            var myfeedid = parseInt($('#feedid').val(), 10);
            if (myfeedid !== 999999999) {
                BRTC_SubscribeStreaming('manualvideo', myfeedid);
            }
        });
    }
    if (gRequest['no_autopublish']) {
        gAutoPublish = false;
        gPublished = false;
    }
    if (gRequest['no_data']) {
        gUsingData = false;
    }
    if (gRequest['no_video']) {
        gUsingVideo = false;
    }
    if (gRequest['no_audio']) {
        gUsingAudio = false;
    }
    if (gRequest['no_receivingvideo']) {
        gReceivingVideo = false;
    }
    if (gRequest['no_receivingaudio']) {
        gReceivingAudio = false;
    }
    if (gRequest['no_showvideobps']) {
        gShowVideobps = false;
    }
    if (gRequest['videoprofile']) {
        gVideoProfile = gRequest['videoprofile'];
        if (gVideoProfile.includes('x')) {
            var strs = gVideoProfile.split('x');
            var w =  strs[0];
            var h_fps =  strs[1].split('@');
            var h = h_fps[0];

            var fps = 15;
            if (h_fps.length > 1) {
                fps = h_fps[1];
            }

            gVideoProfile = {
                'height': {'ideal': h},
                'width': {'ideal': w},
                'frameRate': {'ideal': fps}
            };
        }
    }
    if (gRequest['screenprofile']) {
        gScreenProfile = gRequest['screenprofile'];
    }

    if (gRequest['waitpermissiontimeout']) {
        gWaitPermissionTimeOutMs = gRequest['waitpermissiontimeout'];
    }

    if (gRequest['candidateip']) {
        gCandidateIP = gRequest['candidateip'];
    }
    if (gRequest['candidateport']) {
        gCandidatePort = gRequest['candidateport'];
    }

    if (gRequest['mediaserverip']) {
        gMediaServerIP = gRequest['mediaserverip'];
    }

    if (gRequest['mediaserverdn']) {
        var mediaServerDN = gRequest['mediaserverdn'];

        let xmlHttp = null;
        try { // Firefox, Opera 8.0+, Safari, IE7
            xmlHttp = new XMLHttpRequest();
        }
        catch (e) { // Old IE
            try {
                xmlHttp = new ActiveXObject('Microsoft.XMLHTTP');
            }
            catch (e) {
                window.alert('Your browser does not support XMLHTTP!');
                return;
            }
        }

        // OR https://httpdns.baidubce.com/v3/resolve?account_id=136238&dn=rtc-pn.exp.bcelive.com&sign=7a749f0c527c2e96f0b4ebe519c4d5b2&t=4829521605
        xmlHttp.open('GET', 'https://203.107.1.1/183659/d?host=' + mediaServerDN, true);
        xmlHttp.send();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState === 4) {
                if (xmlHttp.status === 200) {
                    let response = JSON.parse(xmlHttp.responseText);
                    if (response.ips.length > 0) {
                        gMediaServerIP = response.ips[0];
                    }
                }
            }
        };
    }

    if (gRequest['no_showspinner']) {
        gShowSpinner = false;
    }

    if (gRequest['userevent']) {
        gUserEvent = true;
    }

    if (gRequest['sessionevent']) {
        gSessionEvent = true;
    }

    if (gRequest['autologin']) {
        gAutologin = true;
    }

    if (gRequest['bitrate']) {
        gBitRate = parseInt(gRequest['bitrate'], 10);
    }

    if (gRequest['audiobitrate']) {
        gAudioBitRate = parseInt(gRequest['audiobitrate'], 10);
        gAudioStereo = true;
    }

    if (gRequest['audiostereo']) {
        gAudioStereo = true;
    }

    if (gRequest['textroom']) {
        gAutoSubScribe = false;
        gAutoPublish = false;
        gUsingData = false;
        gUsingVideo = false;
        gUsingAudio = false;
        gUsingMessageAPI = true;
        $('#therevideo').hide();
        $('#videos').remove();
    }

    if (gRequest['preview']) {
        gPreviewLocal = true;
        $('#testpreviewvideo').removeClass('hide').show();
        BRTC_DeviceTest_Start({localvideoviewid: 'testpreviewvideo'});
        $('#unpublish').value = 'Publish';
    }

    if (gRequest['messageapi']) {
        gUsingMessageAPI = true;
    }

    if (gRequest['volumemonitor']) {
        gVolumeMonitor = true;
    }

    if (gRequest['no_mirrorlocalvideo']) {
        gMirrorLocalVideo = false;
    }

    if (gRequest['reportmonitordata']) {
        gReportMonitorData = true;
    }
    if (gRequest['reportenv']) {
        gReportEnv = gRequest['reportenv'];
    }

    if (gRequest['dynamicvideoview']) {
        gDynamicRemoteVideoView = true;
    }

    if (gRequest['log']) {
        gLog = true;
    }

    if (gRequest['displayname']) {
        gName = gRequest['displayname'];
    }

    if (gRequest['autoplaymuted']) {
        gAutoPlayMuted = true;
    }

    if (gRequest['multistreamsdk']) {
        gMultiStreamSDK = true;
    }

    if (gRequest['videocodec']) {
        gVideoCodec = gRequest['videocodec'];
    }

    if (gRequest['audiocodec']) {
        gAudioCodec = gRequest['audiocodec'];
    }

    if (gRequest['canvas']) {
        var canvasEle = document.createElement('script');
        canvasEle.src = 'https://brtc-sdk.cdn.bcebos.com/web/demo/canvas/js/game.js?t=2';
        document.body.appendChild(canvasEle);
        gMirrorLocalVideo = false;
    }

    if (gRequest['test']) {
        gLog = true;
        // Add a 'mute' button
        $('#herevideo').append('<button class="button" id="mute"'
            + ' style="z-index:10; position: absolute; bottom: 0px; left: 0px; margin: 15px;">Mute</button>');
        $('#mute').click(function () {
            gMuted = !gMuted;
            BRTC_MuteMicphone(gMuted);
        });
        $('#herevideo').append('<button class="button" id="mutevideo"'
            + ' style="z-index:10; position: absolute; bottom: 0px; left: 70px; margin: 15px;">Video</button>');
        $('#mutevideo').click(function () {
            gVideoMuted = !gVideoMuted;
            BRTC_MuteCamera(gVideoMuted);
        });
        // Add an 'unpublish' button
        $('#herevideo').append('<button class="button" id="unpublish"'
            + ' style="z-index:10; position: absolute; bottom: 0px; right: 0px; margin: 15px;">Un/publish</button>');
        $('#unpublish').click(function () {
            if (gPublished) {
                BRTC_StopPublish().then(()=> {
                    $('#unpublish').value = 'Publish';
                    if (gPreviewLocal) {
                        BRTC_DeviceTest_Start({localvideoviewid: 'testpreviewvideo'});
                    }
                });
                gPublished = false;
            } else {
                if (gPreviewLocal) {
                    BRTC_DeviceTest_Stop();
                }
                BRTC_StartPublish();
                $('#unpublish').value = 'unPublish';
                gPublished = true;
                gMuted = false;
                gVideoMuted = false;
            }
        });
        $('#herevideo').append('<button class="button" id="screen"'
            + ' style="z-index:10; position: absolute; top: 0px; left: 0px; margin: 15px;">Screen</button>');
        $('#screen').click(function () {
            BRTC_SwitchScreen();
        });

        var scriptEle = document.createElement('script');
        scriptEle.src = 'https://code.bdstatic.com/npm/vconsole@3.3.4/dist/vconsole.min.js';
        document.body.appendChild(scriptEle);
        scriptEle.onload = function () {
            window.vConsole = new VConsole();
        };

        $('#actions').removeClass('hide').show();
        $('#audiodevice').removeClass('hide').show();
        $('#audiooutputdevice').removeClass('hide').show();
    }

    $('#downloadapp').click(function () {
        $('#barimg').removeClass('hide').show();
        $('#mpimg').removeClass('hide').show();
        $('#mptitle').removeClass('hide').show();
    });

    $('#start').click(function () {
            var input_roomname = $('#roomname').val();
            var input_appid = $('#appid').val();
            var input_token = $('#token').val();
            var input_brtcserver = $('#brtcserver').val();
            var input_rtmpserver = $('#rtmpserver').val();
            var input_rtmpmixtemplate = $('#rtmpmixtemplate').val();
            $('#twobar').remove();
            $(this).attr('disabled', true).unbind('click');
            BRTC_Start({
                debuglevel: gLog, // true, false, 'all', ['debug','log','error']
                server: input_brtcserver,
                appid: input_appid,
                token: input_token,
                roomname: input_roomname,
                videocodec: gVideoCodec, // 'h264', 'vp8', 'vp9', 'h263', 'h265', 'h266', 'av1'
                audiocodec: gAudioCodec, //'opus', 'pcmu', 'pcma', 'g722', 'isac16', 'isac32'
                userid: input_userid,
                displayname: gName,
                remotevideoviewid: 'therevideo',
                localvideoviewid: 'herevideo',
                remotevideoviewid2: 'therevideo2',
                remotevideoviewid3: 'therevideo3',
                remotevideoviewid4: 'therevideo4',
                remotevideoviewid5: 'therevideo5',
                mirrorlocalvideo: gMirrorLocalVideo,
                aspublisher: gAsPublisher,
                usingdatachannel: gUsingData,
                usingvideo: gUsingVideo,
                usingaudio: gUsingAudio,
                receivingvideo: gReceivingVideo,
                receivingaudio: gReceivingAudio,
                bitrate: gBitRate,
                screenbitrate: gBitRate,
                audiobitrate: gAudioBitRate,
                audiostereo: gAudioStereo,
                showvideobps: gShowVideobps,
                sharescreen: gShareScreen,
                audiodeviceid: null,
                videodeviceid: defaultDeviceID,
                audiooutputdeviceid: null,
                rtmpserver: input_rtmpserver,
                rtmpmixtemplate: input_rtmpmixtemplate,
                rtmpmix: gRtmpmix,
                rtmpmixlayoutindex: gRtmpMixLayoutIndex,
                recording: gRecording,
                autosubscribe: gAutoSubScribe,
                autoplaymuted: gAutoPlayMuted,
                autopublish: gAutoPublish,
                autoresubscribing: !gAutoSubScribe,
                linkdownupthreshold: 50,
                waitpermissiontimeoutms: gWaitPermissionTimeOutMs,
                reportmonitordata: gReportMonitorData,
                reportenv: gReportEnv,
                candidateip: gCandidateIP,
                candidateport: gCandidatePort,
                mediaserverip: gMediaServerIP,
                videoprofile: gVideoProfile,
                // videoprofile: 'lowres','stdres','hires','fhdres','4kres','480x480@15'
                // videoprofile:  {
                //             'height': {'ideal': 240},
                //             'width':  {'ideal': 240}
                //         },
                screensharevideoprofile: gScreenProfile,
                // screensharevideoprofile: 'lowres','stdres','hires','fhdres','4kres','1280x720'
                multistream: gMultiStreamSDK,
                linkdownevent: function () {
                    console.log('linkdownevent');
                },
                linkupevent: function () {
                    console.log('linkupevent');
                },
                userevent: gUserEvent,
                userevent_joinedroom: function (id, display, attribute) {
                    console.log('userevent_joinedroom id: ' + id
                        + ', display: ' + display + ', attribute:' + attribute);
                },
                userevent_leavingroom: function (id, display) {
                    console.log('userevent_leavingroom id: ' + id + ', display: ' + display);
                },
                sessionevent: gSessionEvent,
                mediastate: function (medium, on) {
                    console.log('send medium ' + medium + ' is: ' + on);
                },
                logintimeout: 10000,
                logintimeoutevent: function () {
                    console.log('timeout');
                },
                showspinner: gShowSpinner,
                shownovideo: true,
                remotevideoloading: function (idx) {
                    console.log('remotevideoloading, index:' + idx);
                },
                remotevideoon: function (idx) {
                    console.log('remotevideoon, index:' + idx);
                },
                remotevideooff: function (idx) {
                    console.log('remotevideooff, index:' + idx);
                },
                remotevideocoming: function (id, display, attribute) {
                    console.log('remotevideocoming, feedid:' + id + ':' + display + ':' + attribute);
                    let sel = document.getElementById('feedid');
                    sel.options.add(new Option(display, id));

                    if (!gAutoSubScribe && gDynamicRemoteVideoView) {
                        $('#manualvideo').append('<div style="width: 100%;height: 100%;" id="videoremote_'
                            + id + '"></div>');
                        BRTC_SubscribeStreaming('videoremote_' + id, id);
                    }

                    var ua = navigator.userAgent.toLowerCase();
                    if (ua.match(/MicroMessenger/i) == 'micromessenger' || ua.match(/WxWork/i) == 'wxwork') {
                        setTimeout((x) =>{
                            const video = document.getElementById('remotevideo1');
                                if (video) {
                                    video.play();
                                }
                            }, 1000);

                        setTimeout((x) =>{
                            const w = document.getElementById('waitingvideo1');
                                if (w) {
                                    w.height = 0;
                                    const video = document.getElementById('remotevideo1');
                                    if (video) {
                                        video.autoplay = false;
                                        video.playsinline = false;
                                        video.controls = true;
                                    }
                                }
                            }, 3000);
                    }
                },
                remotevideoleaving: function (id) {
                    console.log('remotevideoleaving, feedid:' + id);
                    if (!gAutoSubScribe && gDynamicRemoteVideoView) {
                        $('#videoremote_' + id).remove();
                    }
                },
                remotevideounpublished: function (id) {
                    console.log('remotevideounpublished, feedid:' + id);
                    if (!gAutoSubScribe && gDynamicRemoteVideoView) {
                        $('#videoremote_' + id).remove();
                    }
                },
                remotedata: function (data, label) {
                    console.log('got remote data:' + data);
                    $('#remotedata').append(data);

                    if (gDoPong) {
                        BRTC_SendData('pong data.');
                    } else if (gDoPing) {
                        setTimeout(function () {
                            BRTC_SendData('new ping.');
                        }, gPingRepeatTime);
                    }
                },
                success: function () {
                    $('#start').removeAttr('disabled').html('退出')
                        .click(function () {
                            $('#start').attr('disabled', true);
                            Cookies.set('state', 'init');
                            BRTC_Stop();
                        });
                    $('#details').remove();
                    $('#rtc_logo_img').remove();
                    $('#videos').removeClass('hide').show();
                    if (($('#videodevice').get(0).options.length > 1) && gAsPublisher && !gShareScreen) {
                        $('#actions').removeClass('hide').show();
                    }

                    if (($('#audiodevice').get(0).options.length > 2) && gAsPublisher) {
                        $('#actions').removeClass('hide').show();
                        $('#audiodevice').removeClass('hide').show();
                    }

                    if ($('#audiooutputdevice').get(0).options.length > 2) {
                        $('#actions').removeClass('hide').show();
                        $('#audiooutputdevice').removeClass('hide').show();
                    }

                    if (gDoPing) {
                        setTimeout(function () {
                            BRTC_SendData('ping data.');
                        }, gPingStartupTime);
                    }

                    if (gAutologin) {
                        Cookies.set('state', 'playing');
                    }

                    var ignore_rooms_for_sendmsg = [
                        '7a5f1d54-e482-4e8e-8610-605d296fc371',
                        '3021725c-fdd7-426d-aee0-9f84b7e6336f',
                        '0cc3b3cb-d07e-4cdf-9ee3-30c5f2b6e361',
                        'b1092ce6-db7c-4bee-8b9a-28da5021d0a0',
                        'ee2e3738-45c5-4027-a6ae-39dea09999f7',
                        '65a5aec3-6450-4747-8484-97028f9cc865',
                        'b0b3d4dd-467d-454f-93d9-678746a7570c',
                        '703cda41-d6a2-4934-a7de-d38b99ee137b',
                        'f2db08ed-d90a-40d7-9adf-d0ae1d598fa4',
                        '2df29610-0fb8-4bbe-877c-51b4fc3515f6',
                        'f5eba0ec-674a-4a21-bff5-e0441b451759',
                    ];

                    if (ignore_rooms_for_sendmsg.indexOf(input_roomname) < 0) {
                        $('#msg').removeClass('hide').show();
                        $('#sendmsg').removeClass('hide').show();
                        $('#saveshot').removeClass('hide').show();
                    }

                    if (gUsingMessageAPI) {
                        BRTC_SetUserAttribute('{name:"red",tel:"123456789"}');
                    }

                    if (gVolumeMonitor) {
                        setInterval(function () {
                            var r = BRTC_GetRemoteAudioLevels();

                            r.forEach(e => {
                                console.log('BRTC_GetRemoteAudioLevels: ' + JSON.stringify(e));
                                if (e.volume === 0) {
                                    console.error('GetRemoteAudioLevels volume is 0: ' + JSON.stringify(e));
                                    console.error(e);
                                }
                            });
                        }, 5000);
                    }
                },
                localvideopublishing: function () {
                    $('#herevideo').block({
                        message: '<b>Publishing...</b>',
                        css: {
                            border: 'none',
                            backgroundColor: 'transparent',
                            color: 'white'
                        }
                    });
                },
                localvideopublished_ok: function () {
                    $('#herevideo').unblock();
                    if (gRequest['canvas']) {
                        const canvas = document.querySelector('canvas');
                        BRTC_ReplaceStream(canvas.captureStream(15));
                    }
                },
                error: function (error) {
                    alert('BRTC: ' + error);
                    window.location.reload();
                    $('#start').removeAttr('disabled');
                },
                destroyed: function (error) {
                    window.location.reload();
                },
                onlocalstream: function (stream, name) {
                    // local stream for display sonic wave
                    console.log('onlocalstream name: ' + name);
                },
                onlocalstream_end: function (name) {
                    // end event of local stream
                    console.log('onlocalstream_end name: ' + name);
                },
                // localvideopublished_closed: function() {
                //     console.log('localvideopublished_closed by server, please do StartPublish again');
                // },
                remotevideo_closed: function (feedid) {
                    console.log('remotevideo_closed(feedid: ' + feedid + ') by server, please do SubScribing again');
                },
                onmessage: function (msg) {
                    // event onmessage.
                    console.log('onmessage id: ' + msg.id + ' data: ' + msg.data);
                    $('#remotedata').append(msg.data);
                },
                onattribute: function (a) {
                    // event onattribute
                    console.log('onattribute id: ' + a.id + ' attribute: ' + a.attribute);
                },
                onrtmpstreaming: function (mode, url, status) {
                    // event onrtmpstreaming
                    console.log('onrtmpstreaming: mode: ' + mode + ', url: ' + url + ', status: ' + status);
                },
                onrecording: function (e) {
                    console.log('onrecording: status: ' + e.status);
                },
                onmsgdelayinfo: function (e) {
                    console.log('onmsgdelayinfo: id: ' + e.id + ', tag: ' + e.data + ' , delay: ' + e.delayms + 'ms');
                },
            });
            Cookies.set('roomname_at_aapid_page', input_roomname);
            Cookies.set('appid', input_appid);
            Cookies.set('userid', input_userid);
            Cookies.set('token', input_token);
            Cookies.set('brtcserver', input_brtcserver);
            Cookies.set('rtmpserver', input_rtmpserver);
            Cookies.set('rtmpmixtemplate', input_rtmpmixtemplate);
        });
    function loadDevice() {
        let callback = {
            success: function (devices) {
                let sel = document.getElementById('videodevice');

                while (sel.options.length) {
                    sel.remove(0);
                }

                for (let i = 0; i < devices.length; i++) {
                    sel.options.add(new Option(devices[i].label || 'camera ' + (i + 1), devices[i].deviceId));
                    if (devices[i].label.includes('FaceTime')) {
                        defaultDeviceID = devices[i].deviceId;
                        sel.options.selectedIndex = i;
                    }
                }

                $('#videodevice').change(function () {
                    BRTC_ReplaceVideo($('#videodevice').val());
                    defaultDeviceID = $('#videodevice').val();
                    BRTC_SetParamSettings({videodeviceid: defaultDeviceID});
                });
            }
        };
        BRTC_GetVideoDevices(callback);

        let audio_callback = {
            success: function (devices) {
                let sel = document.getElementById('audiodevice');

                while (sel.options.length) {
                    sel.remove(0);
                }

                for (let i = 0; i < devices.length; i++) {
                    sel.options.add(new Option(devices[i].label || 'microphone ' + (i + 1), devices[i].deviceId));
                }

                $('#audiodevice').change(function () {
                    BRTC_ReplaceAudio($('#audiodevice').val());
                    BRTC_SetParamSettings({audiodeviceid: $('#audiodevice').val()});
                });
            }
        };
        BRTC_GetAudioInputDevices(audio_callback);

        let audio_output_callback = {
            success: function (devices) {
                let sel = document.getElementById('audiooutputdevice');

                while (sel.options.length) {
                    sel.remove(0);
                }

                for (let i = 0; i < devices.length; i++) {
                    sel.options.add(new Option(devices[i].label || 'speaker ' + (i + 1), devices[i].deviceId));
                }

                $('#audiooutputdevice').change(function () {
                    BRTC_SetAudioOutputDevice($('#audiooutputdevice').val());
                });
            }
        };
        BRTC_GetAudioOutputDevices(audio_output_callback);

        let devices_callback = {
            success: function (devices) {
                console.log('all devices length: ' + devices.length);
            }
        };

        BRTC_SetDevicesChangeListener(function (event) {
                console.log('on devices event: ' + event);
                // BRTC_GetAllDevices(devices_callback);
                BRTC_GetVideoDevices(callback);
                BRTC_GetAudioInputDevices(audio_callback);
                BRTC_GetAudioOutputDevices(audio_output_callback);
            });
    }

    if (gAsPublisher && (gUsingVideo || gUsingAudio)) {
        setTimeout(function () {
            loadDevice();
        }, 300);
    };

    if (gAutologin) {
        if (gState === 'playing') {
            $('#login').hide();
            $('#auto').removeClass('hide').show();
            $('#continueplaying').click(function () {
                $('#login').removeClass('hide').show();
                $('#start').trigger('click');
            });
        }
    }

    ['manualvideo', 'therevideo', 'therevideo1', 'therevideo2',
        'therevideo3', 'therevideo4', 'therevideo5'].forEach(i =>{
            $('#' + i).dblclick(function () {
                if (document.fullscreenElement) {
                    if (document.webkitIsFullScreen) {
                        document.webkitCancelFullScreen();
                    }
                    else if (document.mozFullScreen) {
                        document.mozCancelFullScreen();
                    }
                    else if (document.fullScreen) {
                        document.cancelFullScreen();
                    }
                } else {
                    $('#' + i).get(0).requestFullscreen();
                }
            });
        });
});

function getShot(video, x, y, width, height) {
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');

    ctx.drawImage(video, x, y, width, height, 0, 0, width, height);

    return canvas.toDataURL();
}

function SaveSnapShot() {
    const a = document.createElement('a');
    var len = document.getElementsByTagName('video').length;
    var video = document.getElementsByTagName('video')[len - 1];
    a.style.display = 'none';
    a.href = getShot(video, 0, 0, video.videoWidth, video.videoHeight);
    a.download = 'Snapshot.png';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        }, 1000);
}

</script>

<div class="gotoBaidu">
    <div class="gotobd">
        <a class="dl_subxm" href="#wiki">Wiki</a>&nbsp;&nbsp;
    </div>
</div>

<div class="container" id="login">
        <div class="col-md-12" style="text-align: center">
            <img src="https://code.bdstatic.com/npm/baidurtc@1.0.1/demo/img/rtc_logo.png" id="rtc_logo_img">
            <div >
                <div class = "rtc-title-font-color" >百度智能云RTC
                </div>
            </div>

            <div id="details">
                <div class="row" >
                    <div class="col-md-12" >
                        <div >
                            <div >
                                <div class="rtc-font-color" >请输入房间号/AppID</div>
                            </div>
                            <input autocomplete="off" class="rtc-input-line" autocomplete="off" type="text" placeholder="Room Name" id="roomname" size="40" value="8888"></input><br>
                            <input autocomplete="off" class="rtc-input-line hide" autocomplete="off" type="text" placeholder="User id" id="userid" size="40" value="10086"></input><br>
                            <input autocomplete="off" class="rtc-input-line" autocomplete="off" type="text" placeholder="AppID from Baidu" id="appid" size="40" value=""></input><br>
                            <input autocomplete="off" class="rtc-input-line hide" autocomplete="off" type="text" placeholder="token" id="token" size="80" value="token"></input><br>
                            <input autocomplete="off" class="rtc-input-line hide" autocomplete="off" type="text" placeholder="wss://rtc.exp.bcelive.com/janus" id="brtcserver" size="40" value="wss://rtc.exp.bcelive.com/janus"></input><br>
                            <input autocomplete="off" class="rtc-input-line hide" autocomplete="off" type="text" placeholder="rtmp://" id="rtmpserver" size="40" value=""></input><br>
                            <input autocomplete="off" class="rtc-input-line hide" autocomplete="off" type="text" placeholder="" id="rtmpmixtemplate" size="40" value=""></input>
                    </div>
                    </div>
                </div>
            </div>
            <button class="button big blue" type="button" autocomplete="off" id="start" style="width:300px">进入房间</button>
            <div class="hide rtc-font-color" id="actions">切换摄像头<select class="rtc-font-color"  id="videodevice"></select></br>
            切换麦克风<select class="hide rtc-font-color"  id="audiodevice"></select></br>
            切换扬声器<select class="rtc-font-color"  id="audiooutputdevice"></select>
            </div>
            <div class="hide rtc-font-color" id="pullvideo">选择拉流<select class="rtc-font-color"  id="feedid"></select>
            </div>
            <div id="twobar">
                <div style="height: 50px;"></div>
                <div class="rtc-font-color" id="downloadapp">iOS/安卓App下载(密码brtc)/小程序:</div>
                <a href="d.html">
                <img class="hide" src="https://code.bdstatic.com/npm/baidurtc@1.0.1/demo/bar.png" style="width: 200px; height: 200px;" id="barimg">
                </a></br></br>
                <div class="rtc-font-color hide" id="mptitle">微信小程序:</div>
                <img class="hide" src="https://code.bdstatic.com/npm/baidurtc@1.0.1/demo/mp.png" style="width: 200px; height: 200px;" id="mpimg">
            </div>
            <div class="m-netcall hide" id="videos">
                <div  id="herevideo"></div>
            </div>
        </div>
        <div class="hide" style="width: 70%;height: 500px;" id="manualvideo" title="双击全屏"></div>
        <div class="hide" style="width: 70%;height: 500px;" id="testpreviewvideo"></div>
        <div style="width: 70%;height: 500px;"id="therevideo" title="双击全屏"></div>
        <br><br><br><br><br><br>
        <div style="width: 70%;height: 50px;" class="rtc-font-color" id="remotedata"></div>
        <textarea class="hide" name="msg" id="msg" style="background-color:White;border-color:#C0C0FF;border-width:1px;border-style:Solid;height:50px;width:1100px;">众里寻他千百度~</textarea><br>
        <button class="hide" type="button" onclick="BRTC_SendMessageToUser(document.getElementById('msg').value)" id="sendmsg">发送消息</button>
        <hr><button class="hide" type="button" onclick="SaveSnapShot()" id="saveshot">视频截图</button>
        <div style="width: 70%;height: 500px;" id="therevideo2" title="双击全屏"></div>
        <div style="width: 70%;height: 500px;" id="therevideo3" title="双击全屏"></div>
        <div style="width: 70%;height: 500px;" id="therevideo4" title="双击全屏"></div>
        <div style="width: 70%;height: 500px;" id="therevideo5" title="双击全屏"></div>
</div>
<div class="hide" id="auto">
    <div class="rtc-title-font-color" id="continueplaying" style="width:500px; text-align:center">拉流播放时请不要刷新页面，点击[继续播放]-></div>
</div>

<a name="wiki">Demo 参数说明</a>
<p>
例子: https://brtc.cdn.bcebos.com/brtc.html?r=8888
</p>

<table>
    <tr>
        <td>请求参数名</td>
        <td>缩写</td>
        <td>含义</td>
        <td>默认值</td>
        <td>示例</td>
    </tr>
    <tr>
        <td>roomname</td>
        <td>r</td>
        <td>房间名</td>
        <td>&#39;8888&#39;</td>
        <td>r=8888</td>
    </tr>
    <tr>
        <td>appid</td>
        <td>a</td>
        <td>AppID 值</td>
        <td>&#39;&#39;</td>
        <td>a=appid</td>
    </tr>
    <tr>
        <td>userid</td>
        <td>u</td>
        <td>用户ID号</td>
        <td>随机值</td>
        <td>u=10099</td>
    </tr>
    <tr>
        <td>displayname</td>
        <td>d</td>
        <td>用户显示名称</td>
        <td></td>
        <td>d=Tom</td>
    </tr>
    <tr>
        <td>token</td>
        <td>t</td>
        <td>token串</td>
        <td>对于开启了CA的appid 需要token</td>
        <td>t=no_token</td>
    </tr>
    <tr>
        <td>listener_only</td>
        <td>l</td>
        <td>是否只是听众</td>
        <td>不是听众</td>
        <td>l=1</td>
    </tr>
    <tr>
        <td>sharescreen</td>
        <td>ss</td>
        <td>是否屏幕分享</td>
        <td></td>
        <td>ss=1</td>
    </tr>
    <tr>
        <td>brtcserver</td>
        <td>s</td>
        <td>BRTC服务器地址</td>
        <td></td>
        <td>s=wss://rtc.exp.bcelive.com/janus</td>
    </tr>
    <tr>
        <td>rtmpserver</td>
        <td>-</td>
        <td>RTMP转推服务器地址</td>
        <td>&#39;&#39;</td>
        <td></td>
    </tr>
    <tr>
        <td>rtmpmix</td>
        <td>-</td>
        <td>RTMP转推是否混流</td>
        <td>true</td>
        <td></td>
    </tr>
    <tr>
        <td>rtmpmixtemplate</td>
        <td>-</td>
        <td>RTMP转推混流模版</td>
        <td>无</td>
        <td></td>
    </tr>
    <tr>
        <td>rtmpmixlayoutindex</td>
        <td>-</td>
        <td>RTMP转推混流模版布局位置</td>
        <td>无</td>
        <td></td>
    </tr>
    <tr>
        <td>audiocodec</td>
        <td>ac</td>
        <td>音频编码名称</td>
        <td>opus</td>
        <td>ac=opus</td>
    </tr>
    <tr>
        <td>videocodec</td>
        <td>vc</td>
        <td>视频编码名称</td>
        <td>h264</td>
        <td>vc=h264</td>
    </tr>
    <tr>
        <td>no_autosubscribe</td>
        <td>ns</td>
        <td>不自动拉流</td>
        <td></td>
        <td>ns=1</td>
    </tr>
    <tr>
        <td>no_autopublish</td>
        <td>np</td>
        <td>不自动推流</td>
        <td></td>
        <td>np=1</td>
    </tr>
    <tr>
        <td>no_video</td>
        <td>nv</td>
        <td>推流不使用视频</td>
        <td></td>
        <td>nv=1</td>
    </tr>
    <tr>
        <td>no_audio</td>
        <td>na</td>
        <td>推流不使用音频</td>
        <td></td>
        <td>na=1</td>
    </tr>
    <tr>
        <td>no_receivingvideo</td>
        <td>-</td>
        <td>不接收视频</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>no_receivingaudio</td>
        <td>-</td>
        <td>不接收音频</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>no_showvideobps</td>
        <td>-</td>
        <td>不显示码率</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>videoprofile</td>
        <td>vp</td>
        <td>视频配置</td>
        <td></td>
        <td>vp=240x240@15</td>
    </tr>
    <tr>
        <td>screenprofile</td>
        <td>-</td>
        <td>屏幕共享视频配置</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>candidateip</td>
        <td>c</td>
        <td>指定候选地址IP</td>
        <td>用于专网NAT转发</td>
        <td></td>
    </tr>
    <tr>
        <td>candidateport</td>
        <td>cp</td>
        <td>指定候选地址端口号</td>
        <td>用于专网NAT转发</td>
        <td></td>
    </tr>
    <tr>
        <td>mediaserverip</td>
        <td>mi</td>
        <td>指定媒体服务器IP</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>mediaserverdn</td>
        <td>mn</td>
        <td>指定媒体服务器DNS</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>no_showspinner</td>
        <td>-</td>
        <td>不显示视频加载进度</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>bitrate</td>
        <td>b</td>
        <td>设置视频码率</td>
        <td></td>
        <td>b=300</td>
    </tr>
    <tr>
        <td>audiobitrate</td>
        <td>-</td>
        <td>设置音频码率</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>textroom</td>
        <td>-</td>
        <td>文本聊天模式</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>no_mirrorlocalvideo</td>
        <td>-</td>
        <td>不镜像本地视频</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>reportmonitordata</td>
        <td>-</td>
        <td>上报监控数据</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>dynamicvideoview</td>
        <td>-</td>
        <td>动态创建videoview</td>
        <td></td>
        <td></td>
    </tr>
    <tr>
        <td>log</td>
        <td>-</td>
        <td>打开log</td>
        <td></td>
        <td>log=1</td>
    </tr>
    <tr>
        <td>test</td>
        <td>-</td>
        <td>打开测试开关, 会加载vConsole, 用于手机调试等环境</td>
        <td></td>
        <td>test=1</td>
    </tr>
</table>

</body>
</html>
